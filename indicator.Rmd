---
title: "Indicator Instead of Scale"
author: "Lauren Kappelmeier"
date: "`r Sys.Date()`"
output: html_document
---
```{r}
# Libraries
library(tidyverse)
library(tidytext)
library(tm)
library("brglm2")
library(nnet)
library(glmnet)
```

# Data
```{r}
lines <- readLines("/Users/laurenkappelmeier/Desktop/lyrical-analysis-lkappelmeier/Data/lyran.csv", encoding = "UTF-8", warn = FALSE)
cleaned_lines <- iconv(lines, from = "UTF-8", to = "UTF-8", sub = "byte")
valid_lines <- cleaned_lines[!is.na(cleaned_lines)]
writeLines(valid_lines, "/Users/laurenkappelmeier/Desktop/lyrical-analysis-lkappelmeier/Data/lyran_cleaned.csv")
lyrics_data <- read.csv("/Users/laurenkappelmeier/Desktop/lyrical-analysis-lkappelmeier/Data/lyran_cleaned.csv", fileEncoding = "UTF-8", stringsAsFactors = FALSE)
```

# Stopwords
```{r}
custom_stopwords <- c("ah", "caa","youre", "im", "oh", "ooh", "la","like", "dont", "yeah","just", "say", "ooooh", "lets", "na", "know", "c", "ill", "cause", "can", "wanna", "got", "get", "now", "cant", "right", "ive", "make", "let", "thats", "shes", "well", "come", "nanana", "nananananananananana", "nananana", "mitchell", "que", "sixnine", "gosh", "uhuh", "ohoohoohooh","yeahhhhhh", "uhuhuhuh", "blee", "dooooooone", "y", "lo")
all_stopwords <- c(stopwords("en"), custom_stopwords)
corpus <- VCorpus(VectorSource(lyrics_data$lyrics))

corpus_clean <- corpus %>%
  tm_map(content_transformer(tolower)) %>%
  tm_map(removePunctuation) %>%
  tm_map(removeNumbers) %>%
  tm_map(removeWords, all_stopwords) %>%
  tm_map(stripWhitespace)

cleaned_lyrics <- sapply(corpus_clean, content)

tidy_lyrics <- data.frame(
  name = lyrics_data$name,
  artist = lyrics_data$artist,
  theme = lyrics_data$theme,
  text = cleaned_lyrics,
  row_id = seq_along(lyrics_data$name),
  stringsAsFactors = FALSE
)

lyrics_data <- tidy_lyrics %>%
  mutate(song_artist_id = paste(name, artist, sep = " ")) %>%
  dplyr::select(song_artist_id, theme, text)

lyrics_data_tokens <- lyrics_data %>% 
  mutate(text = as.character(text)) %>% # Ensure text is character
  unnest_tokens(output = word, input = text) %>% # Tokenize
  group_by(song_artist_id, theme, word) %>% 
  summarise(word_present = 1, .groups = "drop") # presence of words

word_song_counts <- lyrics_data_tokens %>%
  distinct(song_artist_id, word) %>%
  count(word, name = "song_count")

words_to_keep <- word_song_counts %>%
  filter(song_count > 3) %>%
  pull(word)

lyrics_data_tokens_filtered <- lyrics_data_tokens %>%
  filter(word %in% words_to_keep)

lyrics_data_wide <- lyrics_data_tokens_filtered %>%
  pivot_wider(names_from = word, 
              values_from = word_present,  
              values_fill = 0,  # missing values with 0
              names_glue = "word_{word}",  # naming words
              names_repair = "unique")  # column names unique
lyrics_theme_binary <- lyrics_data_tokens %>%
  group_by(song_artist_id, theme) %>%
  summarise(theme_indicator = 1, .groups = "drop")
lyrics_theme_onehot <- lyrics_theme_binary %>%
  pivot_wider(
    names_from = theme,
    values_from = theme_indicator,
    values_fill = 0,
    names_glue = "{theme}_theme" # Custom column naming for themes
  )
lyrics_combined <- full_join(lyrics_theme_onehot, lyrics_data_wide, by = join_by(song_artist_id))

# Clean column names (make them safe for formulas)
colnames(lyrics_combined) <- make.names(colnames(lyrics_combined))

```

```{r}
crush_mod <- glm(crush_theme ~ word_alive + word_alone + word_anyone + word_around +
                   word_baby + word_back + word_bed + 
                   word_call + word_cool +
                   word_else +
                   word_girls +
                   word_hands + word_head +
                   word_keep +
                   word_little + word_love + 
                   word_mine + word_move +
                   word_name + word_need + word_night +
                   word_one + 
                   word_stop +
                   word_tell + word_thinking + word_time + word_touch + 
                   word_want + word_wont, 
                 data = lyrics_combined, family = "binomial")
summary(crush_mod)
```

```{r}
lc_theme <- function(theme_name_str) {
  theme_list <- c("song_artist_id", "theme", "crush_theme", "empowerment_theme", "exes_theme", "forbidden.love_theme", "grief_theme", "growth_theme", "happy_theme", "hate_theme", "heartbreak_theme", "jealousy_theme", "love_theme", "mental.health_theme", "moving.on_theme","partying_theme", "rebellion_theme", "religion_theme", "reminiscing_theme", "revenge_theme", "situationship_theme", "toxic.relationship_theme", "unrequited_theme")
  df <- lyrics_combined %>% select(-all_of(setdiff(theme_list, c(theme_name_str))))
  return(df)
}
x_func <- function(theme_name_str, lc_theme){
  form <- as.formula(paste(theme_name_str, "~ ."))
  df <- model.matrix(form, data = lc_theme)[,-1]
  return(df)
}
get_selected_vars_for_theme <- function(theme_name_str, alpha) {
  # Step 1: Subset data to include only relevant theme
  lc_theme_df <- lc_theme(theme_name_str)
  
  # Step 2: Create design matrix
  x <- x_func(theme_name_str, lc_theme_df)
  
  # Step 3: Fit LASSO model with cross-validation
  y <- lc_theme_df[[theme_name_str]]  # extract response as vector
  cv_fit <- cv.glmnet(x, y, alpha = alpha, family = "binomial")
  # Step 4: Extract selected variables
  best_lambda <- cv_fit$lambda.min
  coefs <- coef(cv_fit, s = best_lambda)
  selected_vars <- rownames(coefs)[which(coefs != 0)]
  selected_vars <- setdiff(selected_vars, "(Intercept)")
  
  return(selected_vars)
}
```



```{r}
find_alpha_for_variable_range <- function(x, y, min_vars = 10, max_vars = 150, alphas = seq(0, 1, by = 0.1)) {
  results <- list()

  for (a in alphas) {
    cv_fit <- cv.glmnet(x, y, alpha = a, family = "binomial")
    best_lambda <- cv_fit$lambda.min
    coefs <- coef(cv_fit, s = best_lambda)
    selected <- sum(coefs != 0) - 1  # subtract 1 for intercept

    results[[as.character(a)]] <- list(
      alpha = a,
      num_selected = selected,
      lambda = best_lambda,
      model = cv_fit
    )
  }

  # Filter alphas with number of variables in desired range
  valid <- purrr::keep(results, ~ .x$num_selected >= min_vars && .x$num_selected <= max_vars)

  if (length(valid) == 0) {
    warning("No alpha value found with variable count in desired range.")
    return(NULL)
  }

  # Choose the alpha with closest to the midpoint of desired range
  target <- (min_vars + max_vars) / 2
  best <- valid[[which.min(sapply(valid, function(x) abs(x$num_selected - target)))]]

  return(best)
}

```
```{r}
get_selected_vars_for_theme_with_alpha <- function(theme_name_str, min_vars = 1, max_vars = 50, alphas = seq(0, 1, by = 0.1)) {
  # Prepare data
  lc_theme_df <- lc_theme(theme_name_str)
  x <- x_func(theme_name_str, lc_theme_df)
  y <- lc_theme_df[[theme_name_str]]
  
  results <- list()
  
  for (a in alphas) {
    cv_fit <- cv.glmnet(x, y, alpha = a, family = "binomial")
    best_lambda <- cv_fit$lambda.min
    coefs <- coef(cv_fit, s = best_lambda)
    selected_count <- sum(coefs != 0) - 1  # subtract intercept

    results[[as.character(a)]] <- list(
      alpha = a,
      lambda = best_lambda,
      model = cv_fit,
      selected_count = selected_count,
      coefs = coefs
    )
  }

  # Filter to valid alpha models within range
  valid <- purrr::keep(results, ~ .x$selected_count >= min_vars && .x$selected_count <= max_vars)
  
  if (length(valid) == 0) {
    warning(paste("No suitable alpha found for", theme_name_str))
    return(character(0))
  }

  # Pick alpha with variable count closest to center of desired range
  target <- 25
  best <- valid[[which.min(sapply(valid, function(x) abs(x$selected_count - target)))]]

  selected_vars <- rownames(best$coefs)[which(best$coefs != 0)]
  selected_vars <- setdiff(selected_vars, "(Intercept)")

  return(selected_vars)
}

```


```{r}
crush_vars <- get_selected_vars_for_theme_with_alpha("crush_theme")
empowerment_vars <- get_selected_vars_for_theme_with_alpha("empowerment_theme")
exes_vars <- get_selected_vars_for_theme_with_alpha("exes_theme")
forbidden_love_vars <- get_selected_vars_for_theme_with_alpha("forbidden.love_theme")
grief_vars <- get_selected_vars_for_theme_with_alpha("grief_theme")
growth_vars <- get_selected_vars_for_theme_with_alpha("growth_theme")
happy_vars <- get_selected_vars_for_theme_with_alpha("happy_theme")

hate_vars <- get_selected_vars_for_theme_with_alpha("hate_theme")
heartbreak_vars <- get_selected_vars_for_theme_with_alpha("heartbreak_theme")
jealousy_vars <- get_selected_vars_for_theme_with_alpha("jealousy_theme")

love_vars <- get_selected_vars_for_theme_with_alpha("love_theme")
mental_health_vars <- get_selected_vars_for_theme_with_alpha("mental.health_theme")
moving_on_vars <- get_selected_vars_for_theme_with_alpha("moving.on_theme")
partying_vars <- get_selected_vars_for_theme_with_alpha("partying_theme")
rebellion_vars <- get_selected_vars_for_theme_with_alpha("rebellion_theme")
religion_vars <- get_selected_vars_for_theme_with_alpha("religion_theme")
reminiscing_vars <- get_selected_vars_for_theme_with_alpha("reminiscing_theme")
revenge_vars <- get_selected_vars_for_theme_with_alpha("revenge_theme")
situationship_vars <- get_selected_vars_for_theme_with_alpha("situationship_theme")
toxic_relationship_vars <- get_selected_vars_for_theme_with_alpha("toxic.relationship_theme")
unrequited_vars <- get_selected_vars_for_theme_with_alpha("unrequited_theme")
```
```{r}
lyrics_theme_binary %>% group_by(theme) %>% summarise(n=n(), min_count = n()*.1)
```

```{r}
#crush_vars
sub("^word_", "", growth_vars)
```
Manual Editing
- Preferred to be significant
- Need to make sense
- Aiming for 80% theme accuracy
```{r}
#lyrics_data_tokens_filtered %>% group_by(word, theme) %>% summarise(count = sum(word_present)) %>% filter(word %in% exes_vars_0) %>% filter()
happy_manual <- c("word_good", "word_happy", "word_best", "word_life")

growth_manual <- c("word_change", "word_changing", "word_moving", "word_going", "word_advice", "word_growing", "word_moving", "word_better", "word_flow", "word_darkness", "word_shine", "word_battle")


grief_manual <- c("word_soon", "word_son", "word_dead", "word_escape", "word_goodbye", "word_pray", "word_wings", "word_ashes", "word_someones", "word_died", "word_crossed", "word_thin", "word_sleep")

forbidden_love_manual <- c("word_pretty", "word_picked", "word_woman", "word_boyfriend", "word_explain", "word_girlfriend", "word_mans", "word_secret", "word_perfume", "word_decide")

exes_vars_manual <- c("word_back", "word_dying", "word_ex","word_exes","word_lips", "word_scar", "word_even", "word_guilty", "word_keep", "word_knew", "word_leave", "word_fine", "word_mean")

empowerment_vars_manual <- c("word_business", "word_girls","word_aint","word_boss", "word_million", "word_queen", "word_sexy", "word_shine", "word_wrong", "word_ladies", "word_told", "word_gonna", "word_inside", "word_never", "word_need")

crush_vars_manual <- c("word_baby", "word_will", "word_closer", "word_focus", "word_reality", "word_kissing", "word_cute", "word_hoping", "word_bedroom", "word_body", "word_kiss")
```


```{r}
fit_theme_glm <- function(theme_name, selected_vars, data = lyrics_combined) {
  if (length(selected_vars) == 0) {
    warning(paste("No predictors selected for", theme_name))
    return(NULL)
  }
  
  formula_str <- paste(theme_name, "~", paste(selected_vars, collapse = " + "))
  model <- glm(as.formula(formula_str), data = data, family = "binomial")
  return(model)
}
```
```{r}
crush_mod <- fit_theme_glm("crush_theme", crush_vars)
empowerment_mod <- fit_theme_glm("empowerment_theme", empowerment_vars)
exes_mod <- fit_theme_glm("exes_theme", exes_vars)
forbidden_love_mod <- fit_theme_glm("forbidden.love_theme", forbidden_love_vars)
grief_mod <- fit_theme_glm("grief_theme", grief_vars)
growth_mod <- fit_theme_glm("growth_theme", growth_vars)
#happy_mod <- fit_theme_glm("happy_theme", happy_vars)
hate_mod <- fit_theme_glm("hate_theme", hate_vars)
heartbreak_mod <- fit_theme_glm("heartbreak_theme", heartbreak_vars)
jealousy_mod <- fit_theme_glm("jealousy_theme", jealousy_vars)
love_mod <- fit_theme_glm("love_theme", love_vars)
happy_mod <- fit_theme_glm("happy_theme", happy_vars)
mental_health_mod <- fit_theme_glm("mental.health_theme", mental_health_vars)
moving_on_mod <- fit_theme_glm("moving.on_theme", moving_on_vars)
partying_mod <- fit_theme_glm("partying_theme", partying_vars)
rebellion_mod <- fit_theme_glm("rebellion_theme", rebellion_vars)
religion_mod <- fit_theme_glm("religion_theme", religion_vars)
reminiscing_mod <- fit_theme_glm("reminiscing_theme", reminiscing_vars)
revenge_mod <- fit_theme_glm("revenge_theme", revenge_vars)
situationship_mod <- fit_theme_glm("situationship_theme", situationship_vars)
toxic_relationship_mod <- fit_theme_glm("toxic.relationship_theme", toxic_relationship_vars)
unrequited_mod <- fit_theme_glm("unrequited_theme", unrequited_vars)
```
```{r}
crush_mod_manual <- fit_theme_glm("crush_theme", crush_vars_manual)
#summary(crush_mod_manual)
empowerment_mod_manual <- fit_theme_glm("empowerment_theme", empowerment_vars_manual)
#summary(empowerment_mod_manual)
exes_mod_manual <- fit_theme_glm("exes_theme", exes_vars_manual)
#summary(exes_mod_manual)
forbidden_love_mod_manual <- fit_theme_glm("forbidden.love_theme", forbidden_love_manual)
#summary(forbidden_love_mod_manual)
grief_mod_manual <- fit_theme_glm("grief_theme", grief_manual)
#summary(grief_mod_manual)
growth_mod_manual <- fit_theme_glm("growth_theme", growth_manual)
#summary(growth_mod_manual)
happy_mod_manual <- fit_theme_glm("happy_theme", happy_manual)
summary(happy_mod_manual)
```
```{r}
a <- scores_manual %>% filter(theme == "growth") %>% filter(theme_match=="FALSE") %>% select(song_artist_id)
a1 <- lyrics_data_tokens %>% filter(song_artist_id %in% a$song_artist_id) %>% select(word, word_present) %>% group_by(word) %>% summarise(presence = sum(word_present)) %>% filter(presence > 2)
```

```{r}
#lyrics_data_tokens %>% select(theme, word, word_present) %>% group_by(theme) %>% filter(word == "alive") %>% summarise(presence = sum(word_present))
a1$word
#summary(lm(empowerment_theme ~ word_told+word_girl+word_heart+word_hold+word_inside+word_love+word_maybe+word_name+word_need+word_never+word_night+word_one, data = lyrics_combined))
```




```{r}
scores <- lyrics_combined %>% select(song_artist_id, theme) %>% mutate(
  crush_score = predict(crush_mod, type = "response"),
  empowerment_score = predict(empowerment_mod, type = "response"),
  exes_score = predict(exes_mod, type = "response"),
  forbidden_love_score = predict(forbidden_love_mod, type = "response"),
  grief_score = predict(grief_mod, type = "response"),
  growth_score = predict(growth_mod, type = "response"),
  #happy_score = predict(happy_mod, type = "response"),
  hate_score = predict(hate_mod, type = "response"),
  heartbreak_score = predict(heartbreak_mod, type = "response"),
  jealousy_score = predict(jealousy_mod, type = "response"),
  love_score = predict(love_mod, type = "response"),
  mental_health_score = predict(mental_health_mod, type = "response"),
  moving_on_score = predict(moving_on_mod, type = "response"),
  partying_score = predict(partying_mod, type = "response"),
  rebellion_score = predict(rebellion_mod, type = "response"),
  religion_score = predict(religion_mod,type = "response"),
  reminiscing_score = predict(reminiscing_mod, type= "response"),
  revenge_score = predict(revenge_mod, type = "response"),
  situationship_score = predict(situationship_mod, type = "response"),
  toxic_relationship_score = predict(toxic_relationship_mod, type = "response"),
  unrequited_score =predict(unrequited_mod, type = "response")
)

score_matrix <- scores %>%
  select(crush_score, empowerment_score, exes_score, forbidden_love_score, grief_score, growth_score, 
         #happy_score, 
         hate_score, 
         heartbreak_score, 
         jealousy_score, 
         love_score, 
         mental_health_score, moving_on_score, partying_score, rebellion_score, religion_score,reminiscing_score, revenge_score, situationship_score,toxic_relationship_score, unrequited_score) %>% # add unrequited back
  as.matrix()

max_index <- max.col(score_matrix, ties.method = "first")

theme_names <- c("crush", "empowerment", "exes", "forbidden love", "grief", "growth", 
                 #"happy", 
                 "hate", "heartbreak", 
                 "jealousy", "love", 
                 "mental health", "moving on","partying", "rebellion", "religion", "reminiscing", "revenge", "situationship", "toxic relationship", "unrequited")
scores$predicted_theme <- theme_names[max_index]
scores <- scores %>%
  mutate(theme_match = theme == predicted_theme)
lc <- scores %>% select(song_artist_id, theme, predicted_theme, theme_match, crush_score, empowerment_score, exes_score, forbidden_love_score, grief_score, growth_score, #happy_score, 
                                 hate_score, 
                                 heartbreak_score, 
                                 jealousy_score, love_score, 
                        mental_health_score, partying_score, rebellion_score, religion_score, reminiscing_score, revenge_score, situationship_score, toxic_relationship_score, unrequited_score)
```
```{r}
theme_accuracies <- scores %>%
  group_by(theme) %>%
  summarise(
    correct = sum(theme_match),
    total = n(),
    accuracy = mean(theme_match),
    .groups = "drop"
  ) %>% arrange(accuracy)
mean(lyrics_combined$theme_match)
print(theme_accuracies)
```
```{r}
theme_names <- c("crush", "empowerment", "exes", "forbidden love", "grief", "growth", 
                 "happy", 
                 "hate", "heartbreak", 
                 "jealousy", "love", 
                 "mental health", "moving on","partying", "rebellion", "religion", "reminiscing", "revenge", "situationship", "toxic relationship", "unrequited")
```

```{r}
scores_manual <- lyrics_combined %>% 
  select(song_artist_id, theme) %>% 
  mutate(crush_score = predict(crush_mod_manual, type = "response"),
         empowerment_score = predict(empowerment_mod_manual, type = "response"),
         exes_score = predict(exes_mod_manual, type = "response"),
         forbidden_love_score = predict(forbidden_love_mod_manual, type = "response"),
         grief_score = predict(grief_mod_manual, type = "response"),
         growth_score = predict(growth_mod_manual, type = "response"),
         happy_score = predict(happy_mod_manual, type = "response"))


score_matrix_manual <- scores_manual %>%
  select(crush_score, empowerment_score, exes_score, forbidden_love_score, grief_score, growth_score, happy_score) %>% 
  as.matrix()

max_index_manual <- max.col(score_matrix_manual, ties.method = "first")


scores_manual$predicted_theme <- theme_names[max_index_manual]
scores_manual <- scores_manual %>%
  mutate(theme_match = theme == predicted_theme)
lc <- scores_manual %>% select(song_artist_id, theme, predicted_theme, theme_match, crush_score, empowerment_score, exes_score, forbidden_love_score, grief_score, growth_score, happy_score)

scores_manual %>%
  group_by(theme) %>%
  summarise(
    correct = sum(theme_match),
    total = n(),
    accuracy = mean(theme_match),
    .groups = "drop"
  ) %>% arrange(accuracy)
#mean(lyrics_combined$theme_match)
```

